<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Board.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tetris</a> &gt; <a href="index.source.html" class="el_package">com.example.game.component</a> &gt; <span class="el_source">Board.java</span></div><h1>Board.java</h1><pre class="source lang-java linenums">package com.example.game.component;

import java.util.Map;

import com.example.Router;
import com.example.game.blocks.Block;
import com.example.game.component.GameInputHandler.GameInputCallback;
import com.example.game.component.MenuOverlay.MenuCallback;
import com.example.settings.GameSettings;

import javafx.animation.AnimationTimer;
import javafx.geometry.Insets;
import javafx.scene.canvas.Canvas;
import javafx.scene.canvas.GraphicsContext;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.StackPane;
import javafx.scene.paint.Color;
import javafx.stage.Stage;

public class Board implements GameInputCallback {

    // 동적 셀 크기 (화면 크기에 따라 조정됨)
    private int cellSize;
    private int boardWidth;
    private int boardHeight;

    private StackPane mainContainer; // 메인 컨테이너 (오버레이 포함)
    private BorderPane root; // 게임 보드 레이아웃
    private Canvas canvas;
    private GraphicsContext gc;
    private GameLogic gameLogic;
    private ScorePanel scorePanel;
    private GameSettings gameSettings;
    private MenuOverlay menuOverlay; // 메뉴 오버레이 추가
    private GameInputHandler inputHandler; // 입력 핸들러 추가

    private AnimationTimer gameLoop; // 게임 루프 타이머
<span class="nc" id="L38">    private long lastUpdate = 0; // 블록 마지막 업데이트 시간</span>

<span class="nc" id="L40">    private boolean isPaused = false; // 게임 일시정지 상태</span>
<span class="nc" id="L41">    private boolean isGameOver = false; // 게임 오버 상태</span>

<span class="nc" id="L43">    private final long baseDropInterval = 1_000_000_000L; // 1초 (기본 속도)</span>

<span class="nc" id="L45">    public Board() {</span>
        // 컴포넌츠 초기화
<span class="nc" id="L47">        gameSettings = GameSettings.getInstance();</span>
<span class="nc" id="L48">        gameLogic = new GameLogic();</span>
<span class="nc" id="L49">        scorePanel = new ScorePanel();</span>
<span class="nc" id="L50">        menuOverlay = new MenuOverlay(); // 오버레이 초기화</span>
<span class="nc" id="L51">        inputHandler = new GameInputHandler(this); // 입력 핸들러 초기화</span>

        // 동적 크기 계산
<span class="nc" id="L54">        calculateDynamicSizes();</span>

        // UI 초기화
<span class="nc" id="L57">        initializeUI();</span>
        // 키 입력 처리 설정
<span class="nc" id="L59">        setupKeyHandling();</span>
        // 게임 루프 시작
<span class="nc" id="L61">        startGameLoop();</span>
        // 초기 보드 그리기
<span class="nc" id="L63">        drawBoard();</span>

        // 화면 크기 변경 리스너 등록
<span class="nc" id="L66">        gameSettings.addWindowSizeChangeListener(this::onWindowSizeChanged);</span>
<span class="nc" id="L67">    }</span>

    // GameInputCallback 구현
    @Override
    public void onMoveLeft() {
<span class="nc" id="L72">        gameLogic.moveLeft();</span>
<span class="nc" id="L73">        drawBoard();</span>
<span class="nc" id="L74">    }</span>

    @Override
    public void onMoveRight() {
<span class="nc" id="L78">        gameLogic.moveRight();</span>
<span class="nc" id="L79">        drawBoard();</span>
<span class="nc" id="L80">    }</span>

    @Override
    public void onMoveDown() {
<span class="nc" id="L84">        handleMoveDown();</span>
<span class="nc" id="L85">        drawBoard();</span>
<span class="nc" id="L86">    }</span>

    @Override
    public void onRotate() {
<span class="nc" id="L90">        gameLogic.rotateBlock();</span>
<span class="nc" id="L91">        drawBoard();</span>
<span class="nc" id="L92">    }</span>

    @Override
    public void onHardDrop() {
<span class="nc" id="L96">        hardDrop();</span>
<span class="nc" id="L97">        drawBoard();</span>
<span class="nc" id="L98">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L102">        togglePause();</span>
<span class="nc" id="L103">    }</span>

// togglePause() 메서드 추가
    private void togglePause() {
<span class="nc bnc" id="L107" title="All 4 branches missed.">        if (isPaused || menuOverlay.isVisible()) {</span>
            // 현재 일시정지 상태 또는 메뉴가 열려있음 → 재개
<span class="nc" id="L109">            resumeGame();</span>
        } else {
            // 현재 게임 중 → 일시정지 및 메뉴 표시
<span class="nc" id="L112">            pauseGame();</span>
        }
<span class="nc" id="L114">    }</span>

    @Override
    public void onSettings() {
        // 메뉴가 열려있으면 닫기
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (menuOverlay.isVisible()) {</span>
<span class="nc" id="L120">            resumeGame();</span>
<span class="nc" id="L121">            return;</span>
        }

        // 게임 오버 상태면 게임 오버 메뉴 표시
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (gameLogic.isGameOver()) {</span>
<span class="nc" id="L126">            showGameOverMenu();</span>
<span class="nc" id="L127">            return;</span>
        }

        // 그 외의 경우는 기존 ESC 키 처리
<span class="nc" id="L131">        handleEscapeKey();</span>
<span class="nc" id="L132">    }</span>

    @Override
    public boolean isGameActive() {
<span class="nc bnc" id="L136" title="All 6 branches missed.">        return !isPaused &amp;&amp; !isGameOver &amp;&amp; !gameLogic.isGameOver();</span>
    }

    @Override
    public boolean isMenuVisible() {
<span class="nc" id="L141">        return menuOverlay.isVisible();</span>
    }

    // isPaused() 메서드 추가
    @Override
    public boolean isPaused() {
<span class="nc" id="L147">        return isPaused;</span>
    }

    // 동적 크기 계산
    private void calculateDynamicSizes() {
<span class="nc" id="L152">        int windowWidth = gameSettings.getWindowWidth();</span>
<span class="nc" id="L153">        int windowHeight = gameSettings.getWindowHeight();</span>

        // 점수판과 패딩을 고려한 게임 보드 영역 계산
<span class="nc" id="L156">        int availableWidth = windowWidth - 200; // 점수판 및 패딩 고려</span>
<span class="nc" id="L157">        int availableHeight = windowHeight - 80; // 상하 패딩 고려</span>

        // 가로/세로 비율에 맞춰 셀 크기 계산 (더 제한적인 쪽에 맞춤)
<span class="nc" id="L160">        int cellByWidth = availableWidth / GameLogic.WIDTH;</span>
<span class="nc" id="L161">        int cellByHeight = availableHeight / GameLogic.HEIGHT;</span>

        // 최소 15, 최대 40의 셀 크기 제한
<span class="nc" id="L164">        cellSize = Math.max(15, Math.min(40, Math.min(cellByWidth, cellByHeight)));</span>

<span class="nc" id="L166">        boardWidth = GameLogic.WIDTH * cellSize;</span>
<span class="nc" id="L167">        boardHeight = GameLogic.HEIGHT * cellSize;</span>
<span class="nc" id="L168">    }</span>

    // 화면 크기 변경 콜백
    private void onWindowSizeChanged() {
<span class="nc" id="L172">        calculateDynamicSizes();</span>
<span class="nc" id="L173">        updateCanvasSize();</span>
<span class="nc" id="L174">        drawBoard();</span>
<span class="nc" id="L175">    }</span>

    // 캔버스 크기 업데이트
    private void updateCanvasSize() {
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (canvas != null) {</span>
<span class="nc" id="L180">            canvas.setWidth(boardWidth);</span>
<span class="nc" id="L181">            canvas.setHeight(boardHeight);</span>
        }
<span class="nc" id="L183">    }</span>

    // UI 초기화
    private void initializeUI() {
        // 메인 컨테이너 생성 (오버레이를 위한 StackPane)
<span class="nc" id="L188">        mainContainer = new StackPane();</span>

        // 게임 보드 레이아웃
<span class="nc" id="L191">        root = new BorderPane();</span>
<span class="nc" id="L192">        root.getStyleClass().add(&quot;game-root&quot;);</span>

        // 점수판 설정
<span class="nc" id="L195">        scorePanel.getPanel().getStyleClass().add(&quot;side-panel&quot;);</span>
<span class="nc" id="L196">        canvas = new Canvas(boardWidth, boardHeight);</span>
<span class="nc" id="L197">        gc = canvas.getGraphicsContext2D();</span>

        // 레이아웃 설정
<span class="nc" id="L200">        root.setCenter(canvas);</span>
<span class="nc" id="L201">        root.setRight(scorePanel.getPanel());</span>
<span class="nc" id="L202">        root.setPadding(new Insets(20));</span>

        // 메인 컨테이너에 게임 보드와 오버레이 추가
<span class="nc" id="L205">        mainContainer.getChildren().addAll(root, menuOverlay.getOverlay());</span>
<span class="nc" id="L206">    }</span>

    // 키 입력 처리 설정
    private void setupKeyHandling() {
<span class="nc" id="L210">        mainContainer.setFocusTraversable(true);</span>
<span class="nc" id="L211">        mainContainer.setOnKeyPressed(event -&gt; {</span>
            // 입력 핸들러에게 위임
<span class="nc" id="L213">            boolean handled = inputHandler.handleKeyPressed(event);</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (handled) {</span>
<span class="nc" id="L216">                event.consume(); // 이벤트 처리됨을 표시</span>
            }
<span class="nc" id="L218">        });</span>
<span class="nc" id="L219">    }</span>

    // ESC 키 처리
    private void handleEscapeKey() {
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (gameLogic.isGameOver()) {</span>
<span class="nc" id="L224">            showGameOverMenu();</span>
<span class="nc bnc" id="L225" title="All 4 branches missed.">        } else if (isPaused || menuOverlay.isVisible()) {</span>
<span class="nc" id="L226">            resumeGame();</span>
        } else {
<span class="nc" id="L228">            pauseGame();</span>
        }
<span class="nc" id="L230">    }</span>

    // 게임 일시정지 및 메뉴 표시
    private void pauseGame() {
<span class="nc" id="L234">        isPaused = true;</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (gameLoop != null) {</span>
<span class="nc" id="L236">            gameLoop.stop();</span>
        }

<span class="nc" id="L239">        menuOverlay.showPauseMenu(new MenuCallback() {</span>
            @Override
            public void onResume() {
<span class="nc" id="L242">                resumeGame();</span>
<span class="nc" id="L243">            }</span>

            @Override
            public void onRestart() {
<span class="nc" id="L247">                restartGame();</span>
<span class="nc" id="L248">            }</span>

            @Override
            public void onSettings() {
<span class="nc" id="L252">                showSettingsMenu();</span>
<span class="nc" id="L253">            }</span>

            @Override
            public void onMainMenu() {
<span class="nc" id="L257">                goToMainMenu();</span>
<span class="nc" id="L258">            }</span>

            @Override
            public void onExit() {
<span class="nc" id="L262">                exitGame();</span>
<span class="nc" id="L263">            }</span>
        });
<span class="nc" id="L265">    }</span>

    // 게임 재개
    private void resumeGame() {
<span class="nc" id="L269">        isPaused = false;</span>
<span class="nc" id="L270">        menuOverlay.hide();</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (!gameLogic.isGameOver()) {</span>
<span class="nc" id="L272">            startGameLoop();</span>
        }
<span class="nc" id="L274">        mainContainer.requestFocus();</span>
<span class="nc" id="L275">    }</span>

    // 게임 오버 메뉴 표시
    private void showGameOverMenu() {
<span class="nc" id="L279">        menuOverlay.showGameOverMenu(new MenuCallback() {</span>
            @Override
            public void onResume() {
                // 게임 오버에서는 재개 불가
<span class="nc" id="L283">            }</span>

            @Override
            public void onRestart() {
<span class="nc" id="L287">                restartGame();</span>
<span class="nc" id="L288">            }</span>

            @Override
            public void onSettings() {
<span class="nc" id="L292">                showSettingsMenu();</span>
<span class="nc" id="L293">            }</span>

            @Override
            public void onMainMenu() {
<span class="nc" id="L297">                goToMainMenu();</span>
<span class="nc" id="L298">            }</span>

            @Override
            public void onExit() {
<span class="nc" id="L302">                exitGame();</span>
<span class="nc" id="L303">            }</span>
<span class="nc" id="L304">        }, scorePanel.getScore());</span>
<span class="nc" id="L305">    }</span>

    // 설정 메뉴 표시
    private void showSettingsMenu() {
<span class="nc" id="L309">        menuOverlay.showSettingsMenu(new MenuCallback() {</span>
            @Override
            public void onResume() {
<span class="nc bnc" id="L312" title="All 2 branches missed.">                if (gameLogic.isGameOver()) {</span>
<span class="nc" id="L313">                    showGameOverMenu();</span>
                } else {
<span class="nc" id="L315">                    resumeGame();</span>
                }
<span class="nc" id="L317">            }</span>

            @Override
            public void onRestart() {
<span class="nc" id="L321">                restartGame();</span>
<span class="nc" id="L322">            }</span>

            @Override
            public void onSettings() {
                // 이미 설정 메뉴에 있음
<span class="nc" id="L327">            }</span>

            @Override
            public void onMainMenu() {
<span class="nc" id="L331">                goToMainMenu();</span>
<span class="nc" id="L332">            }</span>

            @Override
            public void onExit() {
<span class="nc" id="L336">                exitGame();</span>
<span class="nc" id="L337">            }</span>
        });
<span class="nc" id="L339">    }</span>

    // 메인 메뉴로 이동
    private void goToMainMenu() {
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (gameLoop != null) {</span>
<span class="nc" id="L344">            gameLoop.stop();</span>
        }

<span class="nc" id="L347">        Stage stage = (Stage) mainContainer.getScene().getWindow();</span>
<span class="nc" id="L348">        Router router = new Router(stage);</span>
<span class="nc" id="L349">        router.showStartMenu();</span>
<span class="nc" id="L350">    }</span>

    // 게임 종료
    private void exitGame() {
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (gameLoop != null) {</span>
<span class="nc" id="L355">            gameLoop.stop();</span>
        }

<span class="nc" id="L358">        Stage stage = (Stage) mainContainer.getScene().getWindow();</span>
<span class="nc" id="L359">        stage.close();</span>
<span class="nc" id="L360">    }</span>

    private void startGameLoop() {
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (gameLoop != null) {</span>
<span class="nc" id="L364">            gameLoop.stop();</span>
        }

<span class="nc" id="L367">        gameLoop = new AnimationTimer() {</span>
            @Override
            public void handle(long now) {
<span class="nc bnc" id="L370" title="All 4 branches missed.">                if (isPaused || menuOverlay.isVisible()) {</span>
<span class="nc" id="L371">                    return;</span>
                }

                // 동적으로 계산된 드롭 간격 사용
<span class="nc" id="L375">                long currentDropInterval = gameLogic.getDropInterval(baseDropInterval);</span>

<span class="nc bnc" id="L377" title="All 2 branches missed.">                if (now - lastUpdate &gt;= currentDropInterval) {</span>
<span class="nc" id="L378">                    handleMoveDown();</span>
                    // 보드 다시 그리기
<span class="nc" id="L380">                    drawBoard();</span>
<span class="nc" id="L381">                    lastUpdate = now;</span>

                    // 속도 정보 업데이트
<span class="nc" id="L384">                    updateSpeedDisplay();</span>
                }
<span class="nc" id="L386">            }</span>
        };
<span class="nc" id="L388">        lastUpdate = System.nanoTime();</span>
<span class="nc" id="L389">        gameLoop.start();</span>
<span class="nc" id="L390">    }</span>

    // 속도 표시 업데이트
    private void updateSpeedDisplay() {
<span class="nc" id="L394">        double speedMultiplier = gameLogic.getSpeedMultiplier();</span>
<span class="nc" id="L395">        int speedLevel = gameLogic.getSpeedLevel();</span>
<span class="nc" id="L396">        scorePanel.updateSpeed(speedMultiplier, speedLevel);</span>
<span class="nc" id="L397">    }</span>

    // 블록 아래로 이동 처리
    private void handleMoveDown() {
<span class="nc" id="L401">        boolean moved = gameLogic.moveDown();</span>

<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (moved) {</span>
            // 블록이 성공적으로 아래로 이동했을 때 점수 증가
<span class="nc" id="L405">            scorePanel.addScore(1);</span>
        } else {

            // 라인 제거 및 점수 계산
<span class="nc" id="L409">            int linesCleared = gameLogic.clearLines();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">            if (linesCleared &gt; 0) {</span>
<span class="nc" id="L411">                scorePanel.calculateLineScore(linesCleared);</span>
                // 속도가 변경되었을 수 있으므로 업데이트
<span class="nc" id="L413">                updateSpeedDisplay();</span>
            }

            // 블록이 맨 위에 닿았는지 확인
<span class="nc bnc" id="L417" title="All 2 branches missed.">            if (gameLogic.isBlockAtTop()) {</span>

<span class="nc bnc" id="L419" title="All 2 branches missed.">                if (!isGameOver) {</span>
<span class="nc" id="L420">                    isGameOver = true;</span>
<span class="nc" id="L421">                    gameOver();</span>
                }
<span class="nc" id="L423">                return;</span>
            }

            // 게임 오버 체크
<span class="nc" id="L427">            boolean spawned = gameLogic.spawnNextPiece();</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            if (!spawned) {</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                if (!isGameOver) {</span>
<span class="nc" id="L430">                    isGameOver = true;</span>
<span class="nc" id="L431">                    gameOver();</span>
                }
            }
        }
<span class="nc" id="L435">    }</span>

    private void gameOver() {
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (gameLoop != null) {</span>
<span class="nc" id="L439">            gameLoop.stop();</span>
        }

        // 현재 Stage 구해와서 GameOverScene 호출
<span class="nc" id="L443">        Stage stage = (Stage) root.getScene().getWindow();</span>
<span class="nc" id="L444">        com.example.gameover.GameOverScene.show(stage, scorePanel.getScore());</span>

<span class="nc" id="L446">    }</span>

    // 보드 그리기
    private void drawBoard() {
<span class="nc" id="L450">        Map&lt;String, Color&gt; currentColors = gameSettings.getCurrentColors();</span>

        // 배경 그리기
<span class="nc" id="L453">        gc.setFill(Color.web(&quot;#1a1a2e&quot;));</span>
<span class="nc" id="L454">        gc.fillRect(0, 0, canvas.getWidth(), canvas.getHeight());</span>

<span class="nc" id="L456">        drawGrid();</span>
<span class="nc" id="L457">        drawPlacedBlocks(currentColors);</span>
<span class="nc" id="L458">        drawCurrentBlock(currentColors);</span>

<span class="nc" id="L460">        scorePanel.updateNextBlock(gameLogic.getNextBlock());</span>

        // 일시정지 오버레이
<span class="nc bnc" id="L463" title="All 4 branches missed.">        if (isPaused &amp;&amp; !menuOverlay.isVisible()) {</span>
<span class="nc" id="L464">            drawPauseOverlay();</span>
        }
<span class="nc" id="L466">    }</span>

    // 그리드 그리기
    private void drawGrid() {
<span class="nc" id="L470">        gc.setStroke(Color.web(&quot;#16213e&quot;));</span>
<span class="nc" id="L471">        gc.setLineWidth(1);</span>

        // 세로 선
<span class="nc bnc" id="L474" title="All 2 branches missed.">        for (int i = 0; i &lt;= GameLogic.WIDTH; i++) {</span>
<span class="nc" id="L475">            gc.strokeLine(i * cellSize, 0, i * cellSize, GameLogic.HEIGHT * cellSize);</span>
        }

        // 가로 선
<span class="nc bnc" id="L479" title="All 2 branches missed.">        for (int i = 0; i &lt;= GameLogic.HEIGHT; i++) {</span>
<span class="nc" id="L480">            gc.strokeLine(0, i * cellSize, GameLogic.WIDTH * cellSize, i * cellSize);</span>
        }
<span class="nc" id="L482">    }</span>

    // 놓여진 블록 그리기
    private void drawPlacedBlocks(Map&lt;String, Color&gt; colorMap) {
        // 보드 상태 가져오기
<span class="nc" id="L487">        int[][] board = gameLogic.getBoard();</span>
<span class="nc" id="L488">        String[][] blockTypes = gameLogic.getBlockTypes();</span>

        // 놓여진 블록 그리기
<span class="nc bnc" id="L491" title="All 2 branches missed.">        for (int row = 0; row &lt; GameLogic.HEIGHT; row++) {</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">            for (int col = 0; col &lt; GameLogic.WIDTH; col++) {</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                if (board[row][col] == 1) {</span>
                    // 블록 색상 결정
<span class="nc" id="L495">                    String cssClass = blockTypes[row][col];</span>
                    // cssClass에 해당하는 색상을 가져오고, 없으면 기본 색상 사용
<span class="nc" id="L497">                    Color blockColor = colorMap.getOrDefault(cssClass, colorMap.get(&quot;block-default&quot;));</span>
                    // 셀 그리기
<span class="nc" id="L499">                    drawCell(col * cellSize, row * cellSize, blockColor);</span>
                }
            }
        }
<span class="nc" id="L503">    }</span>

    // 현재 떨어지는 블록 그리기
    private void drawCurrentBlock(Map&lt;String, Color&gt; colorMap) {
        // 현재 블록 정보 가져오기
<span class="nc" id="L508">        Block currentBlock = gameLogic.getCurrentBlock();</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">        if (currentBlock == null) {</span>
<span class="nc" id="L510">            return;</span>
        }

        // 블록 색상 결정
<span class="nc" id="L514">        Color blockColor = colorMap.get(currentBlock.getCssClass());</span>
<span class="nc" id="L515">        int currentX = gameLogic.getCurrentX();</span>
<span class="nc" id="L516">        int currentY = gameLogic.getCurrentY();</span>

        // 현재 블록 그리기
<span class="nc bnc" id="L519" title="All 2 branches missed.">        for (int i = 0; i &lt; currentBlock.width(); i++) {</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">            for (int j = 0; j &lt; currentBlock.height(); j++) {</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">                if (currentBlock.getShape(i, j) == 1) {</span>
                    // 셀 위치 계산
<span class="nc" id="L523">                    int drawX = (currentX + i) * cellSize;</span>
<span class="nc" id="L524">                    int drawY = (currentY + j) * cellSize;</span>
                    // 셀 그리기
<span class="nc" id="L526">                    drawCell(drawX, drawY, blockColor);</span>
                }
            }
        }
<span class="nc" id="L530">    }</span>

    // 개별 셀 그리기
    private void drawCell(double x, double y, Color color) {
        // 메인 셀
<span class="nc" id="L535">        gc.setFill(color);</span>
<span class="nc" id="L536">        gc.fillRect(x + 1, y + 1, cellSize - 2, cellSize - 2);</span>

        // 하이라이트 효과
<span class="nc" id="L539">        gc.setFill(color.brighter());</span>
<span class="nc" id="L540">        gc.fillRect(x + 2, y + 2, cellSize - 4, 3);</span>
<span class="nc" id="L541">        gc.fillRect(x + 2, y + 2, 3, cellSize - 4);</span>

        // 그림자 효과
<span class="nc" id="L544">        gc.setFill(color.darker());</span>
<span class="nc" id="L545">        gc.fillRect(x + 2, y + cellSize - 5, cellSize - 4, 3);</span>
<span class="nc" id="L546">        gc.fillRect(x + cellSize - 5, y + 2, 3, cellSize - 4);</span>
<span class="nc" id="L547">    }</span>

    // 메인 컨테이너 반환 (오버레이 포함)
    public StackPane getRoot() {
<span class="nc" id="L551">        return mainContainer;</span>
    }

    // 게임 재시작
    public void restartGame() {
<span class="nc bnc" id="L556" title="All 2 branches missed.">        if (gameLoop != null) {</span>
<span class="nc" id="L557">            gameLoop.stop();</span>
        }

<span class="nc" id="L560">        gameLogic.resetGame();</span>
<span class="nc" id="L561">        scorePanel.resetScore();</span>
<span class="nc" id="L562">        isPaused = false;</span>
<span class="nc" id="L563">        isGameOver = false;</span>
<span class="nc" id="L564">        menuOverlay.hide();</span>

<span class="nc" id="L566">        startGameLoop();</span>
<span class="nc" id="L567">        drawBoard();</span>
<span class="nc" id="L568">        mainContainer.requestFocus();</span>
<span class="nc" id="L569">    }</span>

    // 하드 드롭 (블록을 즉시 바닥까지 떨어뜨리기)
    private void hardDrop() {
<span class="nc bnc" id="L573" title="All 2 branches missed.">        while (gameLogic.moveDown()) {</span>
            // 더 이상 내려갈 수 없을 때까지 반복
        }

<span class="nc" id="L577">        int linesCleared = gameLogic.clearLines();</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">        if (linesCleared &gt; 0) {</span>
<span class="nc" id="L579">            scorePanel.calculateLineScore(linesCleared);</span>
<span class="nc" id="L580">            updateSpeedDisplay();</span>
        }
<span class="nc" id="L582">    }</span>

    // 리소스 정리 (게임이 종료될 때 호출)
    public void cleanup() {
<span class="nc bnc" id="L586" title="All 2 branches missed.">        if (gameLoop != null) {</span>
<span class="nc" id="L587">            gameLoop.stop();</span>
        }
<span class="nc" id="L589">        gameSettings.removeWindowSizeChangeListener(this::onWindowSizeChanged);</span>
<span class="nc" id="L590">        scorePanel.cleanup();</span>
<span class="nc" id="L591">    }</span>

    // 일시정지 오버레이 그리기
    private void drawPauseOverlay() {
        // 반투명 배경
<span class="nc" id="L596">        gc.setFill(Color.color(0, 0, 0, 0.7));</span>
<span class="nc" id="L597">        gc.fillRect(0, 0, canvas.getWidth(), canvas.getHeight());</span>

        // &quot;PAUSED&quot; 텍스트
<span class="nc" id="L600">        gc.setFill(Color.WHITE);</span>
<span class="nc" id="L601">        gc.setFont(javafx.scene.text.Font.font(&quot;Arial&quot;, javafx.scene.text.FontWeight.BOLD, 24));</span>

<span class="nc" id="L603">        String pauseText = &quot;PAUSED&quot;;</span>
<span class="nc" id="L604">        javafx.scene.text.Text tempText = new javafx.scene.text.Text(pauseText);</span>
<span class="nc" id="L605">        tempText.setFont(javafx.scene.text.Font.font(&quot;Arial&quot;, javafx.scene.text.FontWeight.BOLD, 24));</span>
<span class="nc" id="L606">        double textWidth = tempText.getBoundsInLocal().getWidth();</span>
<span class="nc" id="L607">        double textHeight = tempText.getBoundsInLocal().getHeight();</span>

<span class="nc" id="L609">        double x = (canvas.getWidth() - textWidth) / 2;</span>
<span class="nc" id="L610">        double y = (canvas.getHeight() + textHeight) / 2;</span>

<span class="nc" id="L612">        gc.fillText(pauseText, x, y);</span>

        // 안내 메시지
<span class="nc" id="L615">        gc.setFont(javafx.scene.text.Font.font(&quot;Arial&quot;, 14));</span>
<span class="nc" id="L616">        String instructionText = &quot;Press ESC to resume&quot;;</span>
<span class="nc" id="L617">        javafx.scene.text.Text tempInstruction = new javafx.scene.text.Text(instructionText);</span>
<span class="nc" id="L618">        tempInstruction.setFont(javafx.scene.text.Font.font(&quot;Arial&quot;, 14));</span>
<span class="nc" id="L619">        double instructionWidth = tempInstruction.getBoundsInLocal().getWidth();</span>

<span class="nc" id="L621">        double instructionX = (canvas.getWidth() - instructionWidth) / 2;</span>
<span class="nc" id="L622">        double instructionY = y + 40;</span>

<span class="nc" id="L624">        gc.setFill(Color.LIGHTGRAY);</span>
<span class="nc" id="L625">        gc.fillText(instructionText, instructionX, instructionY);</span>
<span class="nc" id="L626">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>